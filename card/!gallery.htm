<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Галерея карточек — адаптивная</title>
<link rel="stylesheet" href="swiper-bundle.min.css" />
<style>

:root{
 --tileMin:160px; /* меняется кнопками */
 --tileGap:12px;
 --thumbH:64px;  /* высота нижней ленты в галерее */
 --bg:#f7f7f8;
 --card:#fff;
 --text:#111;
 --muted:#6b7280;
 }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--text)}
.hidden{display:none !important}

/* Верхняя панель управления  */
#topbar{position:sticky;top:0;z-index:10;display:flex;gap:10px;align-items:center;padding:10px;background:#fff;border-bottom:1px solid #e5e7eb}
#topbar .spacer{flex:1}
.btn{background:beige;;font-size:22px;font-weight:bold;}
.btn:active{transform:translateY(1px)}
.btn.secondary{background:#111;color:#fff}

/* Сетка карточек а-ля Google Drive */
#cards{padding:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--tileMin),1fr));gap:var(--tileGap)}
.card{background:var(--card);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);overflow:hidden;display:flex;flex-direction:column}
.card-thumb{min-height:100px;position:relative;background:#eee;aspect-ratio:4/3;/* старые браузеры поддерживают */}
.card-thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block}
.card-name{padding:8px 10px;font-size:14px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-top:1px solid #f0f0f0}

/* Оверлей галереи. В DOM есть всегда, но скрыт скриптом */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.94);display:none;z-index:9999}
#overlay.show{display:flex;flex-direction:column;min-height:0}

/* Основной слайдер сверху, лента прижата к нижнему краю */
#galleryMain{position:relative;flex:1 1 auto;min-height:0;padding:8px 8px calc(var(--thumbH) + 16px)}
#galleryMain .swiper{height:100%}
#galleryMain .swiper-slide{display:flex;align-items:center;justify-content:center}
#galleryMain img{height:100%;max-width:100%;max-height:100%;object-fit:contain}
.swiper-button-prev,.swiper-button-next{color:#fff}

/* Лента миниатюр — прижата к низу */
#thumbStrip{position:fixed;left:0;right:0;bottom:0;padding:0 8px 8px;background:linear-gradient(transparent, rgba(0,0,0,.25));}
#thumbStrip .swiper{height:var(--thumbH)}
#thumbStrip .swiper-slide{width:86px}
#thumbStrip img{width:100%;height:100%;object-fit:cover;border-radius:8px;opacity:.75;border:2px solid transparent}
#thumbStrip .swiper-slide-thumb-active img{opacity:1;border-color:#4f9dff}

#thumbStrip .swiper-slide-thumb-active img {
  transform: scale(1.1); /* Увеличиваем масштаб */
  transition: transform 0.3s ease; /* Плавный переход */
}

/* Адаптив: на маленьких экранах плитки крупнее по умолчанию */
@media (max-width:480px){:root{--tileMin:180px}}

/* фулскрин картинка */
#fullscreen-view {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.9); z-index:1000;
  justify-content:center; align-items:center;
}
#fullscreen-img { max-width:100%; max-height:100%; height: 100%;width: 100%;object-fit: contain;}

#info-box {
  position:fixed; top:5px; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,0.7); color:#fff;
  padding:8px 12px; border-radius:8px;
  font-size:16px; text-align:center;
  z-index:1001; min-width:400px;
}
#progress-wrap { margin-top:6px; background:rgba(255,255,255,0.3); height:8px; border-radius:999px; overflow:hidden; }
#progress-bar { height:100%; width:0%; background:#4caf50; }
#cancel-btn { margin-top:6px; padding:3px 10px; border:none; border-radius:6px; cursor:pointer; }

#external-frame { display:none; position:fixed; inset:0; width:100%; height:100%; border:none; z-index:1002; }
#close-frame {
  display:none; position:fixed; top:10px; right:10px;
  width:40px; height:40px; border-radius:50%;
  background:rgba(0,0,0,0.6); color:#fff;
  font-size:22px; justify-content:center; align-items:center;
  cursor:pointer; z-index:1003; user-select:none;
}
.rb {border: solid 1px;}
.rb div {width:100%;height:40px;}
.rb input:checked + label { background:#D0FFD0; box-shadow:inset 0 3px 6px rgba(0,0,0,0.52); transition:0.2s;}
.rb label, button {
 padding:5px 10px;
 border: 1px solid #BBBBBB;
 background:linear-gradient(to bottom,rgba(255,255,255,1) 0%, rgba(229,229,229,1) 100%);
 box-shadow:0 2px 5px rgba(0,0,0,0.52);
 cursor:pointer;
 border-radius:8px;
}
</style>
</head>

<body>
<div id="topbar">
 <button class="btn" id="btnMinus" aria-label="Меньше">—</button>
 <button class="btn" id="btnPlus" aria-label="Больше">+</button>
 <div class="rb">
   <label for="id_mode">PNG</label>
   <input type="checkbox" name="neizv" id="id_mode" />
 </div>
 <a href="https://postimg.cc/gallery/y7dRbyB">(Галерея на фотохостинге)</a>
 <div class="spacer"></div>
</div>

  <!-- Сетка карточек -->
  <main id="cards" aria-live="polite"></main>

  <!-- Галерея (скрыта по умолчанию, управляется скриптом) -->
  <div id="overlay" aria-hidden="true">
    <div id="galleryMain">
      <div class="swiper" id="mainSwiper">
        <div class="swiper-wrapper" id="mainWrapper"></div>
        <div class="swiper-button-prev" tabindex="0" role="button" aria-label="Назад"></div>
        <div class="swiper-button-next" tabindex="0" role="button" aria-label="Вперёд"></div>
      </div>
    </div>
    <div id="thumbStrip">
      <div class="swiper" id="thumbSwiper">
        <div class="swiper-wrapper" id="thumbWrapper"></div>
      </div>
    </div>

  </div>
  <div id="fullscreen-view">
    <img id="fullscreen-img">
    <div id="info-box" style="display:none">
      <div id="info-text">Идёт загрузка..</div>
      <div id="progress-wrap"><div id="progress-bar"></div></div>
      <button id="cancel-btn">Отмена</button>
    </div>
  </div>

  <iframe id="external-frame"></iframe>
  <div id="close-frame" onclick="closeIframe()">✕</div>

  <!-- Список картинок -->
  <script src="list.js"></script>
  <!-- либа слайдера -->
  <script src="swiper-bundle.min.js"></script>

<script>
 function eid(id){return document.getElementById(id);}
  // ====== Разбор list.js ======
  // Формат строки: "Название; pic; url/pic.png"
  var lines = (window.g_jpg || '').split(/\r?\n/).map(function(s){return s.trim()}).filter(Boolean);
  var images = lines.map(function(line){
    var parts = (line+';;').split(';');
    var name = parts[0].trim(); if(name=='')name='name_pic';
    var jpg  = parts[1].trim(); if(jpg=='')jpg='0'; jpg+='.jpg';
    var png  = parts[2].trim(); if(png=='')png='0.png';
    return { name:name, jpg:jpg, png:png };
  });

  // ====== Рендер карточек (асинхронная подмена 0.jpg -> jpg) ======
  var cards = eid('cards');
  var g_img=[], g_index=0;

  function card_hide(i){cards.style.display='none';;g_index=i;}
  function card_show(){ cards.style.display='grid';sc_img(g_index);}

  function renderCards(){
    cards.innerHTML = '';
    images.forEach(function(item, idx){
      var card = document.createElement('div');g_img[idx]=card;
      card.className = 'card';
      var thumb = document.createElement('div');
      thumb.className = 'card-thumb';
      var im = document.createElement('img');
      im.alt = item.name || ('Картинка ' + (idx+1));
      im.src = '0.jpg'; // плейсхолдер
      thumb.appendChild(im);

      // асинхронная загрузка настоящего JPG
      var pre = new Image();
      pre.onload = function(){ im.src = item.jpg; };
      pre.src = item.jpg;

      // при клике — открыть галерею на нужном слайде
      thumb.addEventListener('click', function(){ 
        if(g_mode())openGallery(idx);
        else loadPNG(idx);
       });

      var name = document.createElement('div');
      name.className = 'card-name';
      name.textContent = item.name || item.jpg;

      card.appendChild(thumb);
      card.appendChild(name);
      cards.appendChild(card);
    });
  }
  renderCards();

  // ====== Кнопки изменения размера плиток ======
  var tileMin = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tileMin')) || 160;
  function applyTile(){ document.documentElement.style.setProperty('--tileMin', tileMin + 'px'); }
  eid('btnMinus').addEventListener('click', function(){ tileMin = Math.max(120, tileMin - 24); applyTile(); });
  eid('btnPlus').addEventListener('click', function(){ tileMin = Math.min(320, tileMin + 24); applyTile(); });

  // ====== Галерея ======
  var overlay = eid('overlay');
  var pngText  = eid('pngText');
  var mainWrapper = eid('mainWrapper');
  var thumbWrapper = eid('thumbWrapper');
  var mainSwiper, thumbSwiper;

  function buildGallery(){
    mainWrapper.innerHTML = '';
    thumbWrapper.innerHTML = '';
    images.forEach(function(item){
      var slide = document.createElement('div');
      slide.className = 'swiper-slide';
      slide.innerHTML = '<img src="'+ item.jpg +'" alt="">';
      mainWrapper.appendChild(slide);

      var tSlide = document.createElement('div');
      tSlide.className = 'swiper-slide';
      tSlide.innerHTML = '<img src="'+ item.jpg +'" alt="">';
      thumbWrapper.appendChild(tSlide);
    });

    thumbSwiper = new Swiper('#thumbSwiper', {
      spaceBetween: 8,
      slidesPerView: 'auto',
      freeMode: true,
      watchSlidesProgress: true,
    });

    mainSwiper = new Swiper('#mainSwiper', {
      spaceBetween: 10,
      loop: false,
      navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
      thumbs: { swiper: thumbSwiper }
    });
  }
  function openGallery(index){
    if (!mainSwiper){ buildGallery(); }
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    mainSwiper.update(); thumbSwiper.update();
    mainSwiper.slideTo(index, 0);
    card_hide(index)
  }
  function closeGallery(){
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
    card_show();
  }

  // Свайп вверх для выхода
  (function(){
    var startY = 0;
    overlay.addEventListener('touchstart', function(e){ if(!overlay.classList.contains('show')) return; startY = e.touches[0].clientY; }, {passive:true});
    overlay.addEventListener('touchend', function(e){ if(!overlay.classList.contains('show')) return; var dy = startY - e.changedTouches[0].clientY; if(dy > 60) closeGallery(); }, {passive:true});
  })();

  // Клавиатура: стрелки для навигации, вверх / Esc — выход
  document.addEventListener('keydown', function(e){
    if(!overlay.classList.contains('show')) return;
    if(e.key === 'ArrowRight'){ mainSwiper.slideNext(); }
    else if(e.key === 'ArrowLeft'){ mainSwiper.slidePrev(); }
    else if(e.key === 'ArrowUp' || e.key === 'Escape'){ closeGallery(); }
  });
  document.addEventListener('dblclick', function(e){closeGallery();});

let currentIndex=-1, isLoading=false, cancelled=false;
const fv=eid('fullscreen-view');
const fi=eid('fullscreen-img');
const ib=eid('info-box');
const it=eid('info-text');
const pb=eid('progress-bar');
const cb=eid('cancel-btn');

function loadPNG(i){
  if(isLoading) return; 
  isLoading=true; cancelled=false; currentIndex=i;
  const {jpg,png}=images[i];
  card_hide(i);cb.style.display='';fv.requestFullscreen();
  fi.src=jpg; fv.style.display='flex'; ib.style.display='block';
  it.textContent='Идёт загрузка..1-3мб'; pb.style.width='0%';

  let pr=0; const int=setInterval(()=>{
   if(cancelled){clearInterval(int);return;}
   pr=Math.min(100,pr+1);
   pb.style.width=pr+'%';
  },200);

  cb.onclick=()=>{cancelled=true; ib.style.display='none'; isLoading=false; 
  clearInterval(int);closeFullscreen();fi.src='0.png';};
  fi.onclick=()=>{cancelled=true; ib.style.display='none'; isLoading=false; 
  clearInterval(int);closeFullscreen();fi.src='0.png';};

  const big=new Image(); big.src=png;
  big.onload=()=>{
   if(cancelled)return;
   clearInterval(int);
   ib.style.display='block';
   it.textContent='Картинка загружена. Клик - выход';
   pb.style.width='100%'; fi.src=png;
   isLoading=false;
   cb.style.display='none';
   setTimeout(()=>{ib.style.display='none'},3000);
  };
  big.onerror=()=>{ if(cancelled)return; clearInterval(int); ib.style.display='block'; it.textContent='Ошибка загрузки PNG'; isLoading=false; };
}
function closeFullscreen(){document.exitFullscreen();
  eid('fullscreen-view').style.display='none';
  eid('info-box').style.display='none';
  card_show(); 
}
function g_mode(){return !eid('id_mode').checked;}
function sc_img(i){ var k,t;
 k=g_img[i]; 
 if(k){// Прокрутить страницу, чтобы элемент был в верхней части экрана
   t = k.getBoundingClientRect(); k.style.border="solid 1px red";
   t =t.top + window.scrollY - 200;
   window.scrollTo({top: t, behavior: 'instant'});
 }
}
applyTile(); //выставить стартовый размер плиток
</script>
</body>
</html>
