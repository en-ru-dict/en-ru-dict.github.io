<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Галерея карточек — адаптивная</title>
<link rel="stylesheet" href="swiper-bundle.min.css" />
<style>
  :root{
    --tileMin:160px; /* меняется кнопками */
    --tileGap:12px;
    --thumbH:64px;  /* высота нижней ленты в галерее */
    --bg:#f7f7f8;
    --card:#fff;
    --text:#111;
    --muted:#6b7280;
    --brand:#1e6bff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--text)}
  .hidden{display:none !important}

  /* Верхняя панель управления */
  #topbar{position:sticky;top:0;z-index:10;display:flex;gap:10px;align-items:center;padding:10px;background:#fff;border-bottom:1px solid #e5e7eb}
  #topbar .spacer{flex:1}
  .btn{appearance:none;border:0;border-radius:12px;background:var(--brand);color:#fff;padding:10px 16px;font-size:22px;line-height:1;cursor:pointer;touch-action:manipulation;box-shadow:0 2px 8px rgba(30,107,255,.3)}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#111;color:#fff}

  /* Сетка карточек а-ля Google Drive */
  #cards{padding:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--tileMin),1fr));gap:var(--tileGap)}
  .card{background:var(--card);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);overflow:hidden;display:flex;flex-direction:column}
  .card-thumb{position:relative;background:#eee;aspect-ratio:4/3;/* Chrome 99 поддерживает */}
  .card-thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block}
  .card-name{padding:8px 10px;font-size:14px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-top:1px solid #f0f0f0}

  /* Оверлей галереи. В DOM есть всегда, но скрыт скриптом */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,.94);display:none;/* включаем скриптом */z-index:9999}
  #overlay.show{display:flex;flex-direction:column;min-height:0}

  /* Основной слайдер сверху, лента прижата к нижнему краю */
  #galleryMain{position:relative;flex:1 1 auto;min-height:0;padding:8px 8px calc(var(--thumbH) + 16px)}
  #galleryMain .swiper{height:100%}
  #galleryMain .swiper-slide{display:flex;/*align-items:center*/;justify-content:center}
  #galleryMain img{max-width:100%;max-height:100%;object-fit:contain}
  .swiper-button-prev,.swiper-button-next{color:#fff}

  /* Лента миниатюр — прижата к низу */
  #thumbStrip{position:fixed;left:0;right:0;bottom:0;padding:0 8px 8px;background:linear-gradient(transparent, rgba(0,0,0,.25));}
  #thumbStrip .swiper{height:var(--thumbH)}
  #thumbStrip .swiper-slide{width:86px}
  #thumbStrip img{width:100%;height:100%;object-fit:cover;border-radius:8px;opacity:.75;border:2px solid transparent}
  #thumbStrip .swiper-slide-thumb-active img{opacity:1;border-color:#4f9dff}

  /* Бейдж прогресса PNG */
  #pngBadge{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:rgba(17,17,17,.8);color:#fff;border-radius:12px;padding:8px 12px;display:none;align-items:center;gap:10px;font-size:14px}
  #pngBadge.show{display:flex}
  .ring{width:18px;height:18px;border-radius:999px;border:2px solid #89b4ff;border-top-color:#fff;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Адаптив: на маленьких экранах плитки крупнее по умолчанию */
  @media (max-width:480px){:root{--tileMin:180px}}
</style>
</head>
<body>
  <div id="topbar">
    <button class="btn" id="btnMinus" aria-label="Меньше">−</button>
    <button class="btn" id="btnPlus" aria-label="Больше">+</button>
    <div class="spacer"></div>
  </div>

  <!-- Сетка карточек -->
  <main id="cards" aria-live="polite"></main>

  <!-- Галерея (скрыта по умолчанию, управляется скриптом) -->
  <div id="overlay" aria-hidden="true">
    <div id="galleryMain">
      <div class="swiper" id="mainSwiper">
        <div class="swiper-wrapper" id="mainWrapper"></div>
        <div class="swiper-button-prev" tabindex="0" role="button" aria-label="Назад"></div>
        <div class="swiper-button-next" tabindex="0" role="button" aria-label="Вперёд"></div>
      </div>
    </div>
    <div id="thumbStrip">
      <div class="swiper" id="thumbSwiper">
        <div class="swiper-wrapper" id="thumbWrapper"></div>
      </div>
    </div>
    <div id="pngBadge"><span class="ring"></span><span id="pngText">Загрузка…</span></div>
  </div>

  <!-- Данные -->
  <script src="list.js"></script>
  <!-- Локальная библиотека -->
  <script src="swiper-bundle.min.js"></script>

  <script>
  // ====== Разбор list.js ======
  // Формат строки: "Название; pic.jpg; url/pic.png" или "Название; pic; url/pic.png"
  // Допускается пропуск .jpg — добавим автоматически. PNG можно не указывать — возьмём jpg и заменим расширение.
  var lines = (window.g_jpg || '').split(/\r?\n/).map(function(s){return s.trim()}).filter(Boolean);
  var images = lines.map(function(line){
    var parts = line.split(';').map(function(s){return (s||'').trim()});
    var name = parts[0] || '';
    var jpg  = parts[1] || '0';
    var png  = parts[2] || '';
    if (!/\.jpg(\?|$)/i.test(jpg)) jpg += '.jpg'; // поддержка "+jpg"
    if (!jpg || jpg === '0') jpg = '0.jpg';
    if (!png){
      // если PNG не задан, делаем из JPG
      png = jpg.replace(/\.jpg(\?.*)?$/i, '.png$1');
    }
    return { name:name, jpg:jpg, png:png };
  });

  // ====== Рендер карточек (асинхронная подмена 0.jpg -> jpg) ======
  var cards = document.getElementById('cards');
  function renderCards(){
    cards.innerHTML = '';
    images.forEach(function(item, idx){
      var card = document.createElement('div');
      card.className = 'card';

      var thumb = document.createElement('div');
      thumb.className = 'card-thumb';
      var im = document.createElement('img');
      im.alt = item.name || ('Картинка ' + (idx+1));
      im.src = '0.jpg'; // плейсхолдер
      thumb.appendChild(im);

      // асинхронная загрузка настоящего JPG
      var pre = new Image();
      pre.onload = function(){ im.src = item.jpg; };
      pre.src = item.jpg;

      // при клике — открыть галерею на нужном слайде
      thumb.addEventListener('click', function(){ openGallery(idx); });

      var name = document.createElement('div');
      name.className = 'card-name';
      name.textContent = item.name || item.jpg;

      card.appendChild(thumb);
      card.appendChild(name);
      cards.appendChild(card);
    });
  }
  renderCards();

  // ====== Кнопки изменения размера плиток ======
  var tileMin = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tileMin')) || 160;
  function applyTile(){ document.documentElement.style.setProperty('--tileMin', tileMin + 'px'); }
  document.getElementById('btnMinus').addEventListener('click', function(){ tileMin = Math.max(120, tileMin - 24); applyTile(); });
  document.getElementById('btnPlus').addEventListener('click', function(){ tileMin = Math.min(320, tileMin + 24); applyTile(); });

  // ====== Галерея ======
  var overlay = document.getElementById('overlay');
  var pngBadge = document.getElementById('pngBadge');
  var pngText  = document.getElementById('pngText');

  var mainWrapper = document.getElementById('mainWrapper');
  var thumbWrapper = document.getElementById('thumbWrapper');
  var mainSwiper, thumbSwiper;

  function buildGallery(){
    mainWrapper.innerHTML = '';
    thumbWrapper.innerHTML = '';
    images.forEach(function(item){
      var slide = document.createElement('div');
      slide.className = 'swiper-slide';
      slide.innerHTML = '<img src="'+ item.jpg +'" alt="">';
      mainWrapper.appendChild(slide);

      var tSlide = document.createElement('div');
      tSlide.className = 'swiper-slide';
      tSlide.innerHTML = '<img src="'+ item.jpg +'" alt="">';
      thumbWrapper.appendChild(tSlide);
    });

    thumbSwiper = new Swiper('#thumbSwiper', {
      spaceBetween: 8,
      slidesPerView: 'auto',
      freeMode: true,
      watchSlidesProgress: true,
    });

    mainSwiper = new Swiper('#mainSwiper', {
      spaceBetween: 10,
      loop: false,
      navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
      thumbs: { swiper: thumbSwiper }
    });

    // Клик по большой картинке — запросить PNG
    mainWrapper.addEventListener('click', function(){
      var i = mainSwiper.activeIndex;
      askAndLoadPNG(i);
    });
  }

  function openGallery(index){
    if (!mainSwiper){ buildGallery(); }
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    mainSwiper.update(); thumbSwiper.update();
    mainSwiper.slideTo(index, 0);
  }

  function closeGallery(){
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
  }

  // Свайп вверх для выхода
  (function(){
    var startY = 0;
    overlay.addEventListener('touchstart', function(e){ if(!overlay.classList.contains('show')) return; startY = e.touches[0].clientY; }, {passive:true});
    overlay.addEventListener('touchend', function(e){ if(!overlay.classList.contains('show')) return; var dy = startY - e.changedTouches[0].clientY; if(dy > 60) closeGallery(); }, {passive:true});
  })();

  // Клавиатура: ← → для навигации, ↑ / Esc — выход
  document.addEventListener('keydown', function(e){
    if(!overlay.classList.contains('show')) return;
    if(e.key === 'ArrowRight'){ mainSwiper.slideNext(); }
    else if(e.key === 'ArrowLeft'){ mainSwiper.slidePrev(); }
    else if(e.key === 'ArrowUp' || e.key === 'Escape'){ closeGallery(); }
  });

  // ====== Загрузка PNG с прогрессом и заменой JPG ======
  var pngLoaded = {}; // индекс -> blobURL, чтобы не перекачивать
  function askAndLoadPNG(i){
    var item = images[i];
    if(!item) return;
    if(!confirm('Загрузить PNG (~2MB)?')) return;

    if(pngLoaded[i]){
      swapMainImage(i, pngLoaded[i]);
      return;
    }

    pngBadge.classList.add('show');
    pngText.textContent = '0%';

    var xhr = new XMLHttpRequest();
    xhr.open('GET', item.png, true);
    xhr.responseType = 'blob';
    xhr.onprogress = function(e){ if(e.lengthComputable){ pngText.textContent = Math.round(e.loaded / e.total * 100) + '%'; } };
    xhr.onerror = function(){ pngBadge.classList.remove('show'); alert('Не удалось загрузить PNG'); };
    xhr.onload = function(){
      if(xhr.status >= 200 && xhr.status < 300){
        var url = URL.createObjectURL(xhr.response);
        pngLoaded[i] = url; // кэшируем
        swapMainImage(i, url);
      } else {
        alert('Ошибка ' + xhr.status);
      }
      pngBadge.classList.remove('show');
    };
    xhr.send();
  }

  function swapMainImage(i, url){
    var slide = mainWrapper.children[i];
    if(!slide) return;
    var img = slide.querySelector('img');
    if(img) img.src = url; // заменить jpg на png
  }

  // ====== Инициализация: выставить стартовый размер плиток ======
  applyTile();
  </script>
</body>
</html>
