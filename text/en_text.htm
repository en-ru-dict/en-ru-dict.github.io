<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EngRead v8 RU (Адаптивное чтение)</title>
  <link rel="stylesheet" href="en_text.css" />
</head>
<body>
<noscript>
  <div style="font-size:40px">JavaScript должен быть включён!</div>
</noscript>
<script src="d3000.txt"></script>
<script src="en_text.js"></script>
<header>
  <h1>EngRead v7 Учебная программа для адаптивного чтения и изучения английских слов</h1>
  <button id="btnSpeak" title="Озвучить выделенный текст">Озвучить</button>

  <label class="small">:
   <select id="id_tools">
    <option value="loadLWL" selected>Загр список изуч.слов из ЛокСт</option>
    <option value="loadLWF">Загр список выуч.слов из файла(замена)</option>
    <option value="addLWF">Загр список выуч.слов из файла(добавить)</option>
    <option value="saveLWF">Сохр список выуч.слов в файл</option>
    <option value="addAWLW">Добавить все активные слова в список выуч.слов</option>
    <option value="loadBigDict">Загр бол.словарь в IDB 7мб 1 раз (перезаписать)</option>
    <option value="showWords" disabled>Показать перевод слов из бол.словаря</option>
    <option value="genText">Генерировать текст через чат бота GPT</option>
   </select>
  </label>
  <label class="small">Режим:
    <select id="id_mode">
	<option value="text">Перевод текста через переводчик</option>	
    <option value="all">Все слова с переводом</option>
    <option value="only" selected>Перевод только невыученных</option>
    </select>
  </label>
  <label class="small">Словарь:
    <select id="id_dict">
    <option value="d600.txt">600 базовый А1</option>
    <option value="d3000.txt" selected>NGSL-3000 А2</option>
    <option value="d7000.txt">7000 (5k+формы) В2</option>
    </select>
  </label>
  <button id="btnToggleLayout" title="Развернуть правую панель">↔</button>
  <button onclick="helpme()" title="Подробное описание программы">Help</button>
  <button disabled id="id_lang" title="Выбрать язык интерфейса" style="margin-left: auto;">RU</button>
</header>

<div class="grid" id="id_mainGrid">
  <section class="card" id="id_leftCard">
    <textarea id="id_text" placeholder="Вставьте английский текст сюда" spellcheck="false"></textarea>
    <div class="small">Подсказка: клик по слову → добавить в выученные. Выделение + озвучка.</div>
    <textarea id="id_aw" placeholder="Активные слова (через запятую или перенос строки)" spellcheck="false"></textarea>
  </section>
  <section class="card">
    <div class="toolbar mrow" id="id_rightCard">
      <span class="pill small">Найдено: <span id="id_statAll">0</span></span>
      <span class="pill small">Выученные: <span id="id_statLW">0</span></span>
      <span class="pill small">Активные: <span id="id_statAW">0</span></span>
      <span class="pill small">Редкие: <span id="id_statRW">0</span></span>
    </div>
    <div id="id_out" class="out hide-tr"></div>
  </section>
</div>

<!-- модальное окно для показа большого перевода -->
<div id="id_show_big_tr" class="modal-overlay" onclick="if(event.target == g_modal)hideModal();">
 <div class="modal-content">
  <div class="modal-title">
   <b class="modal-word">Заголовок</b>
   <button onclick="hideModal()">Закрыть</button>
  </div>
  <div class="center-screen">
    <div class="modal-text">
     ---
    </div>
  </div>
 </div>
</div>

<!-- модальное окно редактирования перевода -->
<div id="id_edit_big_tr" class="modal-overlay modal" onclick="if(event.target == g_modal)hideModal();">
  <div class="modal-box">
    <div id="id_modal-word">word</div>
    <div class="small">Введите перевод:</div>
    <input id="id_modal-input"/>
    <div class="modal-row">
      <button onclick="hideModal()">Отмена</button>
      <button onclick="saveModalEd()">Сохранить</button>
    </div>
  </div>
</div>

<!-- список всех слов (подробный просмотр) -->
<div id="id_wordsList" class="hide">
 <div id="id_search_container">
  <input type="text" id="id_search_input" oninput="search_word()" placeholder="Введите слово...">
  <button onclick="closeWordList()">Закрыть</button>
 </div>
 <div id="id_dict_container" onclick="container_click(event)"></div>
</div>

<script>
function checkCompatibility(){ //проверка браузера и пишем юзеру проблемы.
  const features = [
    { name: 'Map (ES6)', check: 'Map' in window },
    { name: 'Promise (ES6)', check: 'Promise' in window },
    { name: 'async/await (ES7)', check: typeof (async () => {}) === 'function' },
    { name: 'querySelector', check: 'querySelector' in document },
    { name: 'Element.closest', check: !!Element.prototype.closest },
    { name: 'localStorage', check: 'localStorage' in window },
    { name: 'indexedDB', check: 'indexedDB' in window },
    { name: 'SpeechSynthesis (speaking)', check: 'speechSynthesis' in window },
  ];

  const unsupported = features.filter(f => !f.check).map(f => f.name);
  const screenWidth = window.innerWidth;

  let message = '';
  if (unsupported.length > 0){
    message += 'Ваш браузер слишком старый или не поддерживает некоторые функции. Программа может работать с ошибками или не работать вовсе.\n\n';
    message += 'Неподдержанные функции: ' + unsupported.join(', ') + '.\n\n';
    message += 'Рекомендуем обновить браузер до:\n- Chrome 58+ (Android 58+)\n- Firefox 55+\n- Safari 12.1+ (iOS 12.2+)\n- Edge 79+\n- Opera 45+\n';
    message += 'Если это старый IE или Safari <10, обновите или используйте другой браузер.';
    alert(message); //надо переводить
  } else console.log('браузер потянет');

  if (screenWidth < 600){
    alert('Экран слишком маленький (ширина ' + screenWidth + 'px). Программа предназначена для ПК или планшетов. На телефоне может не влезть интерфейс — попробуйте повернуть устройство или использовать больший экран.');
  } else if (screenWidth < 768) {
    alert('Экран маловат (' + screenWidth + 'px) — может всё не влезет.');
  }
}
function speakText(opts){//долгая
  if(!('speechSynthesis' in window)){alert('TTS speak не поддерживается');return 0;}
  if(window.speechSynthesis.speaking){window.speechSynthesis.cancel();return 1;}//stop
  let txt = window.getSelection().toString().trim();
  let e = el('id_text'); if(!e){log('нет id_text');return 0;}
  txt = txt || ''+e.value;
  if(!txt){alert('Нет текста для озвучки'); return 0;}
  try {
    if(startBusy('speakText','начало озвучки ('+txt.length+' симв.',0))return 0;
    opts = opts || {};
    let utter = new SpeechSynthesisUtterance(txt);
    utter.lang = opts.lang || 'en-US';
    utter.rate = opts.rate || 1.0;
    utter.pitch = opts.pitch || 1.0;
    utter.volume = opts.volume || 1.0;
    utter.onend = (e)=>{endBusy('speakText','конец озвучки');}
    utter.onerror = (e)=>{endBusy('speakText','ошибка озвучки');};
    speechSynthesis.speak(utter);
  } catch(e){alert('Ошибка озвучки='+e);endBusy('speakText');}
}
// пишем список изуч слов в локалсторе автоматически = gm_lw
function saveLWL0(){
 let t=getLW();
 let m=t.split('\n');
 try {localStorage.setItem('knownEnglishWords',t);log('Записано в ЛокСт='+t.length+'/'+m.length);}
 catch(e){alert('saveLWL: ошибка или лимит localStorage!'+e);}
}
function loadLWL(){ //читаем из локалсторе (стираем текущие и активные)
 let t,k;
 gm_lw.clear();
 try{
  t=localStorage.getItem('knownEnglishWords');
  if(t){t=t.split('\n');for(k of t)if(k)gm_lw.set(k,1);}//там точно norm-key/trim/lowcase
  alert('Загружено из ЛокСт '+gm_lw.size+' выуч.слов');
  setTimeout(render,0);//обновить разметку
 } catch(e){alert('loadLWL: Ошибка чтения из ЛокСт='+e);}
}
function addAWLW(){//все активные в выученные и очистить поле
 for(let [k,v] of gm_aw)if(k)gm_lw.set(k,1);
 alert('Добавлено='+gm_aw.size+' слов+очистим');
 gm_aw.clear(); el('id_aw').value='';
 saveLWL();
 setTimeout(render,0);//обновить разметку
}
// Меню действий
  function fTools(p){
   if(p=='loadLWL') loadLWL();
   if(p=='loadLWF') loadFromFile(loadLWF);
   if(p=='addLWF')  loadFromFile(addLWF2);
   if(p=='saveLWF') saveToFile('my_words.txt','g_words=`\n' + getLW() + '`;');
   if(p=='addAWLW') addAWLW();
   if(p=='loadBigDict') {progressBar(1,100);loadScript('big_dict.txt',loaderBigDict);}
   if(p=='showWords') showListWords();
   if(p=='genText') window.open('gen_text.htm', '_blank');
}
// Основной модуль рендера текста, подсветки слов и редактирования переводов

function setModeTr(){
  let mode_tr=getModeTr();
  if(mode_tr=='only')el('id_out').classList.add('hide-tr');
  if(mode_tr=='all')el('id_out').classList.remove('hide-tr');
  if(mode_tr=='text'){
   let text = ''+el('id_text').value;
   if(!text){el('id_out').innerHTML = '';return 0;}
   text = normText(text);
   copyToClipboard(text); //offline
   alert('текст скопирован в буфер обмена, для офлайн перевода, для онлайн пытаемся перевести через гугл переводчик');
   let url='https://translate.google.com/?sl=en&tl=ru&text=' + encodeURIComponent(text);
   window.open(url,'_blank');
   return 1;
  }
}

//главный быстрый рендер 70-90% слов должен найти в словаре юзера
function render0(){
 try{
  let text = ''+el('id_text').value;
  if(!text){el('id_out').innerHTML = '';return 0;}
  text = normText(text);

//=======основной рендер
  if(startBusy('render','начинаем рендер текста',999))return 0;
  text=' '+text+' ';
  let tokens = text.match(/([A-Za-z'-]+|[^A-Za-z'-]+)/g) || [];
  let html = '';
  let classMap = ['uw','lw','aw','rw'];
  gm_words.clear(); //слова текста уникальные, key norm
  for(const t0 of tokens){
    let t = t0;
    let key = '';
    if(t!='-')if(t!="'")if(t.match(/([A-Za-z'-]+)/g)!=null)key=normKey(t);
    t = escapeHTML(t);
    if(key){ //это слово в норм виде
    gm_words.set(key,1);
      let status = getWordStatus(key);
      let tr = getTran(key);
      let trShort = '(' + tr + ')';
      let cls = classMap[status];
      let class_key='wb '+cls+' w-'+key.replace(/[^a-z]/g,'');
        t=`<span class="${class_key}"><span class="ww" title="${escapeAttr(tr)}">${t}`;
        t+='</span>·<span class="tr">'+escapeHTML(trShort)+'</span></span>';
      }
      html += t;
    }
    el('id_out').innerHTML = html;
    statWords();
    log('render1 закончен, уник.слов='+gm_words.size);
    showTimer('render');
} catch(e){alert('Ошибка рендера1='+e); endBusy('render');}
// ========== Рендер 2-го этапа ==========
  log('начинаем render2, флаг занято уже стоит с рендера1');
  //если в gm_dict2 есть перевод или ???, то повторно не ищем
  let m=[];for( let [k,v] of gm_words)if(!gm_dict2.has(k))m.push(k);
  if(m.length===0){endBusy('render','render2: нет слов'); return 1;}
  readIDB(m).then((z)=>{ //читаем все слова из текста а не только nw
    let unknowns = document.querySelectorAll('#id_out .wb.rw');
    let replaced = 0;
    for(let wb of unknowns){
      let el_ww=wb.children[0];
      let el_tr=wb.children[1];
      let key = normKey(el_ww.textContent);
      let tr = getTran(key);
      if(tr !== '??'){
        el_ww.title = escapeAttr(tr);
        el_tr.textContent = '(' + tr + ')'; //=escapeHTML
        replaced++;
      }
    }
    endBusy('render','render2 закончен, заменено=' + replaced);
  }).catch((e)=>{alert('render2: er ='+e);endBusy('render');});
}

// Управление базой данных IndexedDB и визуальный прогресс загрузки

// == Фоновая загрузка бол.словаря, если есть дубли, то будет только последнее значение!
async function loaderBigDict(){//долгая и асинх
  if(!window.g_big_dict){ alert('Нет g_big_dict'); return 0;}
  if(startBusy('loaderBigDict','начало записи бол.словаря в IDB='+g_big_dict.length,1000))return 0;
  try{
    await openIDB();
    log('открыли БД');
    const BATCH = 3000;
    let batch = [];
    let done = 0;
    let n1=0,n2=0,k,v,s,le=g_big_dict.length;
    while(1){
      n2=g_big_dict.indexOf('\n',n1);
      if(n2>=0){
       s=g_big_dict.substring(n1,n2); n1=n2+1;
       [k,v] = s.split('|'); k = normKey(k); v = v || '?';
       if(k)batch.push([k,v.trim()]);
      }
      if(batch.length >= BATCH || n2<0){
        await writeBatchToIDB(batch);
        done += batch.length;
        batch = [];
        progressBar(n1,le);
      }
      if(n2<0)break;
    }
    endBusy('loaderBigDict','конец записи бол.словаря в IDB');
    alert('В IndexedDB добавлено слов='+done);
    countIDB();
    gm_dict2.clear(); //???-там везде на редких если не было этого словаря
    g_big_dict = null; //free mem
    setTimeout(render,0);//обновить разметку
  }
  catch(e){alert('error loaderBigDict='+e);}
}
function createProgressBar() {
  const div = document.createElement('div');
  div.className = 'progress-overlay';
  div.innerHTML = '<div class="progress-box"><div class="bar-label">Загрузка...</div><div class="bar-frame"><div class="bar-fill"></div></div></div>';
  document.body.appendChild(div);
  g_progress.el = div;
}
</script>


<script>
console.log('выполняется секция с init');
// ------------------- инициализация -------------------
window.g_log_mode=1;//0-no msg;
function null_map(){return new Map();} //с массивами [] и объектами {} много проблем

function init(){ 
 console.log('en_text: init start');
 checkCompatibility();
 // ------------------- глобальные структуры -------------------
 window.g_dict= window.g_dict || '';
 window.g_words=window.g_words || '';

 window.gm_lw = null_map();  // выученные (0,1)
 window.gm_aw = null_map();  // активные (0,1)

 window.gm_dict  = null_map();  // малый словарь юзера (ключ → перевод)
 window.gm_dict2 = null_map();  // кэш большого словаря для слов из текста
 window.gm_words = null_map();  // актуальные слова текста
 window.gm_sost  = null_map();  // составные слова look-for из малого словаря
 window.gm_busy  = null_map();  // флаги занято

 window.g_progress = { el: null, timer: null, lastUpdate: 0, hideDelay: 5000 };
 window.g_lastTapTime = 0;  //для тапов и кликов надо
 window.g_IDB = null; //глобальная перем indexedDB
 window.g_modal=null; //модалка для закрыть

 //весь ввод юзера дебаунсим на 350мс для защиты от частых вызовов после ввода буквы
 //window.loadAW=debounce(loadAW0,350); 
 window.render=debounce(render0,350);
 window.saveLWL=debounce(saveLWL0,350); 

 el('btnSpeak').addEventListener('click',speakText);
 el('id_mode').addEventListener('change',setModeTr);
 el('id_tools').addEventListener('change',(e)=>{fTools(e.target.value);});
 el('id_dict').addEventListener('change',(e)=>{loadScript(''+e.target.value,loadDict);});
 el('id_text').addEventListener('input',render);
 el('id_aw').addEventListener('input',loadAW);

 el('btnToggleLayout').addEventListener('click',(e)=>{
   const left = el('id_leftCard');
   const grid = el('id_mainGrid');
   if(left.style.display === 'none'){left.style.display = 'block';grid.style.gridTemplateColumns = '1fr 1fr';}
   else {left.style.display = 'none'; grid.style.gridTemplateColumns = '1fr';}
 });
 // ошибки IndexedDB
 window.addEventListener('error', (e)=>{
    if(e.message.includes('IDB'))alert('IndexedDB повреждён. Очистите кеш сайта.');
 });

 el('id_out').addEventListener('click', (e)=>{ //клики и тапы все тут
  e.stopPropagation();
  let wb = e.target.closest('.wb'); 
  if(!wb) return;
  tap(e,wb);
 });
 // "Контекстное меню" (Правая кнопка мыши на ПК / Долгое нажатие на Android)
 el('id_out').addEventListener('contextmenu', function(e){
  //e.preventDefault(); пока не надо, вешаем ввод перевода?
  log('Событие: Контекстное меню (ПК)');
 });

 window.addEventListener('beforeunload',(e)=>{if(g_IDB)g_IDB.close();saveLWL0();});

 loadDict(); // g_dict -> gm_dict
 openIDB();  // открыть один раз для всех IndexedDB
 countIDB('Внимание! Нет большого словаря в indexedDB'); // проверка что словарь есть если нет то алерт
 loadLWL();  // загрузка изученных слов из ЛокСт
 loadAW();   // загрузка активных слов из текст.поля

 // примерный текст (необязательно)
 loadScript('textA2.txt',(e)=>{el('id_text').value=''+window.g_text;render();});
 log('init end');
}
function helpme(){  
 g_modal = el('id_show_big_tr'); 
 if (g_modal) g_modal.classList.add('visible');
let s=`Прога для адаптивного чтения и изучения английского, Может работать в браузере локально без интернета.(Скачайте к себе на ПК/планшет/телефон, для андроид 10+ поставьте Simple HTTP Server)

Словари есть для en-ru. 3 уровня и большой. Для своего языка ищите и делайте сами. Для изучения НЕ англ. надо менять фильтры символов, настроено на буквы (a-z), другие молча удалит.

Выберете словарь уровня. Вставьте англ текст в левое поле, в правом будет текст с переводом каждого слова из текущего словаря. Цель: выучить все слова из этого словаря. Кликните по слову чтобы добавить в выученные, перевод скрывается. Двойной клик - подробный перевод с примерами и ассоц. из бол.словаря если подключен.

Активные слова. Если только что выучили в Анки итд, то здесь их закрепляете в контексте, попросите чат бота ИИ написать текст вашего уровня где эти слова встречаются в разных вариантах.
`;
show_msg_center(s);
}
window.addEventListener('load', init);//тут надо переводчик запускать а он запустит init
</script>

</body>
</html>


















